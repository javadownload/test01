common/header.jsp
common/footer.jsp



------------------- index.jsp 구조잡기 ------------------------------
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
    

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Book App</title>

<link rel="stylesheet" href="./css/my.css">
<link rel="stylesheet" href="./css/main.css">
    
    
    
</head>
<body>
<%@ include file="common/header.jsp" %>

<div id="output">
<section>
<div>
<h3> link List</h3>


<ul>
<c:if test="${empty login}"> 
   <li> <a href="${pageContext.request.contextPath}/login.jsp"> LogIn </a></li><br>
</c:if> 

<c:if test="${!empty login }"> 
   <li> <a href="${pageContext.request.contextPath}/logout.do"> LogOut </a></li><br>
   <li> <a href="${pageContext.request.contextPath}/bookList.do"> Book List </a></li><br>
   <li> <a href="${pageContext.request.contextPath}/book.jsp"> Book 등록 </a></li><br>
</c:if> 

</ul>

</div>
</section>
</div>
<%@ include file="common/footer.jsp" %>


</body>
</html>




--------------------------------------------------------------

book.jsp
bookList.jsp 수정

login.jsp



******************** viewBook.do 처리 *******************      
<td><a href="viewBook.do?bookno=${data.bookno}"> ${ data.title } </a></td> 



@WebServlet({ "/viewBook.do" })
public class ViewBookServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;

	protected void service(HttpServletRequest request, 
			               HttpServletResponse response) 
					throws ServletException, IOException {
		
		request.setCharacterEncoding("utf-8");
		response.setContentType("text/html;charset=utf-8");
      
		int no = Integer.parseInt(request.getParameter("bookno"));

//		HttpSession session = request.getSession();
//        String login = (String) session.getAttribute("login");
//        System.out.println("login : "+login);
//		if(login == null) {
//			//response.sendRedirect("login.jsp");
//	         request.setAttribute("msg", "login이 필요합니다.");
//
//			getServletContext().
//			getRequestDispatcher("/login.jsp").
//			forward(request, response);
//			return;
//		}
        
		BookDAO_Mariadb dao = new BookDAO_Mariadb();
		BookService service = new BookServiceImpl(dao);

		BookVO vo = service.getBook(no);
		request.setAttribute("book", vo);
		
		getServletContext().
		getRequestDispatcher("/book_view.jsp").
		forward(request, response);
		
	}

}


****************************  book_view.jsp  **************************


<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
    
    
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<title>My WebApplication ...</title>
<link rel="stylesheet" href="./css/my.css">
<link rel="stylesheet" href="./css/main.css">

<script >
	function bookList() {
		f.action="bookList.do"
		f.submit();
	}
	function bookModify() {
		f.action="bookmodify.do";
		f.submit();
	}
	function bookRemove() {
		if ( confirm("정말 삭제하시겠습니까?") ) {
			f.action="bookDelete.do";
			f.submit();
		}
	}
</script>


</head>
<body>

<%@ include file="common/header.jsp" %>
<section>
<h2> ...... </h2>



<!-- view Form  -->
	  <form name="f" method="post" action="">
	  <input type="hidden" name="bookno" value="${book.bookno}">
	  <table>
		  <tr>
			<td >도서제목</td>
			<td > ${book.title}	</td>
		  </tr>
		  <tr>
			<td >출판사</td>
			<td >${book.publisher}</td>
		  </tr>
		  <tr>
			<td >가격</td>
			<td >${book.price}</td>
		  </tr>		
		  <tr>
			<td >이미지</td>
			<td ><img alt="" src="./img/book1.png" width="200" height="200"></td>
		  </tr>		
		  
	  </table>
	  </form>
	  


     <table>
		  <tr>
			<td align=center>
			<input type="button" value="수정" onClick="bookModify()"> &nbsp;
			<input type="button" value="삭제" onClick="bookRemove()"> &nbsp;
			<input type="button" value="목록" onClick="bookList()"> 
			</td>
		  </tr>
	 </table>
	 

</section>
<%@ include file="common/footer.jsp" %>
</body>
</html>


실행해 보면서 에러 수정 :  get / post /service 처리 





-------------------------- login.jsp ----------------------------------
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
    

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Book App</title>
<link rel="stylesheet" href="./css/my.css">
<link rel="stylesheet" href="./css/main.css">
</head>
<body>
<%@ include file="common/header.jsp" %>

<div id="output">
<section>


<h1>login form 처리   post 방식</h1>

<form action="login.do" method="post">
   <table border="1">
       <tr>
          <td colspan="2">
                <span style="color:red">${msg}</span>
          </td>
       </tr>
      <tr>
         <td><label for="id">ID</label></td>
         <td>
             <input type="text" id="id" name="id" value="" 
                  required="required" placeholder="아이디입력" 
                  pattern="\w{6,12}" title="영문자숫자로 6~12 글자사이입력 "/> 
         </td>      
      </tr>
      <tr>
         <td><label for="pw">PW</label></td>
         <td><input type="password" id="pw" name="pw" value="" required="required"/> </td>
      </tr>
       <tr>
         <td colspan="2">
             <input type="submit" value="로그인">
             <input type="reset" value="취소">
             <a href="users.html">회원가입</a>
         </td>
      </tr>
   </table>
</form>

</section>
</div>
<%@ include file="common/footer.jsp" %>


</body>
</html>

********** UserVO  / UserService /  UserDAO_Mariadb *****************
**********   UserDAO_Mariadb *****************

public class UserDAO_Mariadb {
     
	public UserVO login(UserVO user) {
		String sql ="select * from user where id=? and password=?";
		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		UserVO vo = null;
		try {
			con = JDBCUtil.getConnection();
			ps = con.prepareStatement(sql);
			ps.setString(1, user.getId());
			ps.setString(2, user.getPassword());
			
			rs = ps.executeQuery();
			//결과값 처리 
			while(rs.next()) {
				vo = new UserVO();
				vo.setId(rs.getString("id"));
				vo.setName(rs.getString("name"));
				vo.setPassword(rs.getString("password"));
				vo.setRole(rs.getString("role"));
			}
		}catch (Exception e) {
		     e.printStackTrace();	
		}finally {
			JDBCUtil.close(con, ps, rs);
		}
		return vo;
	}
}
********** login logout  / LoginServlet*****************

@WebServlet({ "/login.do", "/logout.do" })
public class LoginServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;

	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		request.setCharacterEncoding("utf-8");
		response.setContentType("text/html;charset=utf-8");

		String id = request.getParameter("id");
		String pw = request.getParameter("password");

		UserDAO_Mariadb dao = new UserDAO_Mariadb();
		UserService service = new UserServiceImpl(dao);

		UserVO vo = new UserVO();
		vo.setId(id);
		vo.setPassword(pw);
		UserVO login = service.login(vo);

		if (login != null) {
			HttpSession session = request.getSession();
			session.setAttribute("login", login);
			
			RequestDispatcher rd = null;
			rd = request.getRequestDispatcher("index.jsp");
			rd.forward(request, response);
			
		} else {
			request.setAttribute("msg", "로그인 정보를 다시 입력하세요");
			// response.sendRedirect("./login.jsp");

			RequestDispatcher rd = null;
			rd = request.getRequestDispatcher("login.jsp");
			rd.forward(request, response);
		}
	}

	protected void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		HttpSession session = request.getSession();
		if (session != null) {
			session.invalidate();
		}

		response.sendRedirect("./index.jsp");
	}

}

-----------------------------

      <tr>
          <td colspan="2">
          <span style="color:red">${msg}</span>
          </td>
       </tr>


******************************************************
전체적인 login 여부 검사 

HttpSession session = request.getSession();
String login = (String) session.getAttribute("login");
System.out.println("login : "+login);
if(login == null) {
	//response.sendRedirect("login.jsp");
 request.setAttribute("msg", "login이 필요합니다.");

	getServletContext().
	getRequestDispatcher("/login.jsp").
	forward(request, response);
	return;
}

***************************************************

******************** error.jsp *******************************


---error.jsp -----------

<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page isErrorPage="true" %>
   
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
    

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Book App</title>

<link rel="stylesheet" href="./css/button.css">
<link rel="stylesheet" href="./css/table.css">
<link rel="stylesheet" href="./css/main.css">
    
    
    
</head>
<body>
<%@ include file="common/header.jsp" %>

<div id="output">
<section>

<h3> Error page</h3>
<h4 style="color: red;"> 서버 점검 중입니다. </h4>
<div style="color: red;"> <%= exception %> </div>
<div style="color: red;"> ${exception} </div>



</section>
</div>
<%@ include file="common/footer.jsp" %>


</body>
</html>



----------------------------------
public interface BookService {
	
	 List<BookVO> bookList();
	 void bookAdd(BookVO vo) throws Exception;
	 void deleteBook(int bookno);
	 void updateBook(BookVO vo);
	 
	 List<BookVO> searchBook(String condition,String keyword);
}
--------------------------------------
public void bookAdd(BookVO vo) throws Exception{
        String sql = "insert into book (bookno ,title,publisher,price) " + 
        		"values ((select nvl(max(bookno),0)+1 from book)  ,?,?,?)";
	~~~~


                         int i = ps.executeUpdate();
			if(i == 0) throw new Exception("등록 실패");
		} catch (Exception e) {
			//System.out.println(e);
			throw e;
		}finally {
			JDBCUtil.close(rs, ps, con);
		}


-----------------InsertBookServlet--------------------
@WebServlet({"/insertbook.do" })
public class InsertBookServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
	
	protected void doPost(HttpServletRequest request, 
			              HttpServletResponse response) 
			              throws ServletException, IOException {
		
		request.setCharacterEncoding("utf-8");
		response.setContentType("text/html;charset=utf-8");
		PrintWriter out = response.getWriter();
		
		BookDAO dao = new BookDAO_JDBC();
		BookService service = new BookServiceImpl(dao);
		BookVO vo =  new BookVO();
		vo.setPublisher(request.getParameter("publisher"));
		vo.setPrice(Integer.parseInt(request.getParameter("price")));
		vo.setTitle(request.getParameter("title"));
		try {
			service.bookAdd(vo);
			response.sendRedirect("bookList.do");
			//out.print("<h1>"+i+"개의 row 입력 완료");
		} catch (Exception e) {
			//out.print("<h2> 문제 발생 : "+e);
			request.setAttribute("exception", e);
			
			getServletContext().
			getRequestDispatcher("/error.jsp").
			forward(request, response);
		}
	}
}

