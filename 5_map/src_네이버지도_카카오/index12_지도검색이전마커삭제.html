<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<title>간단한 지도 표시하기</title>
<link rel="stylesheet" href="./css/style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script type="text/javascript"
	src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=key값"></script>
	
<script type="text/javascript" 
src="//dapi.kakao.com/v2/maps/sdk.js?appkey=key값&libraries=services"></script>
	
</head>
<body>
	<div id="navbar">My Map</div>
	<div id="infoBox">
		<div id="infoTitle">현재날짜</div>
		<div id="infoContent">2020년11월20일</div>
	</div>
	<div id="search">
	   <input type="text" name="" id="keyword" placeholder="목적지를 입력해주세요 ">
	   <button id="btn">검색</button>
	</div>
	
	<div id="current">내위치</div>

	<div id="map" style="width: 100%; height: 100vh;"></div>

	<script type="text/javascript" src="./js/data.js"></script>
	<script type="text/javascript">
        navigator.geolocation.getCurrentPosition(initMap);

        var map = null;

        function initMap(location) {
        	
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.3595704, 127.105399), //지도의 센터위치 네이버본사 
                zoom: 10
            });
          

            let markerList = [];
            let infoWindowList = [];
            
            for(let i in data){
            	let target = data[i];
            	console.log(target);
            	 var marker = new naver.maps.Marker({
                     map: map,
                     position: new naver.maps.LatLng(target.lat,target.lng), 
                     icon:{
                     	content:"<div class='maker'></div>",
                     	ancher:new naver.maps.Point(12,12) //마커의 중심좌표 설정 
                     }
                 });
            	 //`` 백틱으로 자바스크립트 객체 처리 
            	 let content = `<div class="info_wrap">
            	    <div>${target.title}</div>
            	    <div>${target.content}</div>
            	    <div>${target.date}</div>
            	 </div>`;
            	 var info = new naver.maps.InfoWindow({
            		 content:content,
            		 backgroundColor: "#00ff0000",
            		 ancherSize:new naver.maps.Size(0,0)
            	 });

            	 markerList.push(marker);
            	 infoWindowList.push(info);
            }
           
            for(let i=0;i<markerList.length;i++){
            	 naver.maps.Event.addListener(markerList[i], 'click', fn1(i)); 
            	 naver.maps.Event.addListener(map, 'click', fn2(i)); 

            }
            
            function fn1(i) {
				return function() {
					let marker = markerList[i];
					let infoWindow = infoWindowList[i];
					
					if(infoWindow.getMap()){
						infoWindow.close();
					}else{
						infoWindow.open(map,marker);
					}
				}
			}
            function fn2(i) {
				return function() {
					infoWindowList[i].close();
				}
            }
            $('#current').click(()=>{
            	    if(navigator.geolocation){
            	    	alert("위치정보사용가능");
            	    	navigator.geolocation.getCurrentPosition(function(location) {
							const lat = location.coords.latitude;
							const lng = location.coords.longitude;
			                const loc =  new naver.maps.LatLng(lat,lng);
			                marker = new naver.maps.Marker({
			                	 map: map,
			                     position: loc,
			                     icon:{
			                      	content:"<img class='plus' src='./img/c.png'/>",
			                      	ancher:new naver.maps.Point(12,12)  
			                      }
			                });
			                map.setZoom(14,false);
			                map.panTo(loc);
            	    	});
            	    }else{
						alert("이기능(위치정보)은 브라우저가 지원하지 않습니다.");
					}
            });
            
           let ps = new kakao.maps.services.Places();

            $("#keyword").on("keydown",function(e){
            	if(e.keyCode === 13){
            		//alert("enter");
            		let keyword = $(this).val();
            		//alert(keyword);
            		ps.keywordSearch(keyword,fn3);
            	}
            });
            
            function fn3(data,status,pnum) {
				if(status === kakao.maps.services.Status.OK){
					//console.log(data);
					let target = data[0];
					const lat = target.y;
					const lng = target.x;
					const loc =  new naver.maps.LatLng(lat,lng);
					marker.setMap(null);
	                marker = new naver.maps.Marker({
	                	 map: map,
	                     position: loc
	                     
	                });
	                map.setZoom(14,false);
	                map.panTo(loc);
					
				}else{
					alert("no");
				}
			}
        }
    </script>
</body>
</html>